generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model User {
    id            Int            @id @default(autoincrement())
    email         String         @unique
    password      String
    firstname     String
    lastname      String
    videos        Video[]
    comments      Comment[]
    subscriptions Subscription[] @relation("subscribers")
    subscribers   Subscription[] @relation("subscribedTo")
    likes         Like[]
    refreshTokens RefreshToken[]
    createdAt     DateTime       @default(now())
    history    WatchHistory[]
    watchLater WatchLater[]
    sentNotifications     Notification[] @relation("sentNotification")
    receivedNotifications Notification[] @relation("receivedNotification")
}

model RefreshToken {
    id        Int      @id @default(autoincrement())
    token     String   @unique
    user      User     @relation(fields: [userId], references: [id])
    userId    Int
    createdAt DateTime @default(now())
    revoked   Boolean  @default(false)
}

model Video {
    id          Int       @id @default(autoincrement())
    title       String
    description String?
    url         String
    thumbnail   String?
    duration    Int?
    views       Int       @default(0)
    user        User      @relation(fields: [userId], references: [id])
    userId      Int
    comments    Comment[]
    likes       Like[]
    createdAt   DateTime  @default(now())
    search_vector Unsupported("tsvector")? @default(dbgenerated())
    history   WatchHistory[]
    watchLater WatchLater[]
    @@index([search_vector], type: Gin)
}

model Comment {
    id          Int       @id @default(autoincrement())
    commentText String
    user        User      @relation(fields: [userId], references: [id])
    userId      Int
    video       Video     @relation(fields: [videoId], references: [id])
    videoId     Int
    
    // --- New Fields for Threading ---
    parentId    Int?     
    parent      Comment?  @relation("CommentToReplies", fields: [parentId], references: [id], onDelete: Cascade)
    replies     Comment[] @relation("CommentToReplies")
    
    createdAt   DateTime  @default(now())
}

model Like {
    id        Int      @id @default(autoincrement())
    user      User     @relation(fields: [userId], references: [id])
    userId    Int
    video     Video    @relation(fields: [videoId], references: [id])
    videoId   Int
    createdAt DateTime @default(now())

    @@unique([userId, videoId])
}

model Subscription {
    id             Int      @id @default(autoincrement())
    subscriber     User     @relation("subscribers", fields: [subscriberId], references: [id])
    subscriberId   Int
    subscribedTo   User     @relation("subscribedTo", fields: [subscribedToId], references: [id])
    subscribedToId Int
    createdAt      DateTime @default(now())

    @@unique([subscriberId, subscribedToId])
}

model WatchHistory {
    id        Int      @id @default(autoincrement())
    
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId    Int
    
    video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
    videoId   Int
    
    watchedAt DateTime @default(now())

    @@unique([userId, videoId]) 
    @@index([userId])
}

model WatchLater {
    id        Int      @id @default(autoincrement())
    
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId    Int
    
    video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
    videoId   Int
    
    addedAt DateTime @default(now())

    @@unique([userId, videoId]) 
    @@index([userId])
}

model Notification {
    id Int @id @default(autoincrement())
    type String
    sender User @relation("sentNotification",fields: [senderId], references: [id])
    senderId Int
    receiver User @relation("receivedNotification",fields: [receiverId], references: [id])
    receiverId Int
    videoId Int?
    isRead Boolean @default(false)
    createdAt DateTime @default(now())
}



